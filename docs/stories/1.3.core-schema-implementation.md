# Story 1.3: Core Schema Implementation - VOD & Admin Authorship

## Status
Ready for Development

## Story

**As a** CSN platform developer,
**I want** core database schema tables for VOD content management and admin authorship tracking,
**so that** admins can upload, manage, and publish video content with full audit trails and the system can track who created/modified content.

## Acceptance Criteria

1. **Media Assets Table**: Implement `media_assets` table for VOD upload management:
   - Support for video, image, and audio file types
   - UploadThing integration fields (key, URL)
   - Video metadata (duration, dimensions)
   - Optional HLS streaming URL (future-proof)
   - Folder organization via path strings
   - Tag-based categorization
   - Upload status tracking (uploading/ready/failed/archived)
   - Authorship and timestamp tracking
   - View count analytics

2. **Enhanced Content Table**: Add authorship and workflow fields to existing `content` table:
   - Creator tracking (`created_by`, `created_at`)
   - Editor tracking (`updated_by`, `updated_at`)
   - Enhanced workflow states (draft → pending_review → approved → published → archived)
   - Review tracking (`reviewed_by`, `reviewed_at`)
   - Media asset relationships (`media_asset_ids`)
   - All existing content functionality preserved

3. **Content Audit Log Table**: Implement `content_audit_log` for change tracking:
   - Track both `content` and `media_assets` entity changes
   - Capture action types (created/updated/published/archived/deleted)
   - Store user details (ID, email, role)
   - Optional change diffs (before/after)
   - Timestamp all audit entries
   - Indexed for fast querying by entity and user

4. **Query Optimization**: Add proper indexes for performance:
   - Index all foreign keys
   - Index frequently queried fields (status, created_by, timestamps)
   - Add search indexes where appropriate
   - Document index strategy for future developers

5. **Migration Safety**: Ensure backwards compatibility:
   - No breaking changes to existing queries
   - Test all existing content queries still work
   - Document migration path from current schema
   - Provide rollback strategy if needed

## Tasks / Subtasks

- [ ] **Design Media Assets Table** (AC: 1)
  - [ ] Define table schema in `convex/schema.ts`
  - [ ] Add all required fields per Winston's design
  - [ ] Create indexes: by_status, by_uploader, by_type
  - [ ] Add search index for title field
  - [ ] Document field purposes inline

- [ ] **Enhance Content Table** (AC: 2)
  - [ ] Add authorship fields (created_by, updated_by, created_at, updated_at)
  - [ ] Add workflow_status enum field
  - [ ] Add review fields (reviewed_by, reviewed_at)
  - [ ] Add media_asset_ids array field
  - [ ] Create new indexes: by_created_by, by_workflow_status
  - [ ] Verify existing indexes still optimal

- [ ] **Design Content Audit Log Table** (AC: 3)
  - [ ] Define table schema in `convex/schema.ts`
  - [ ] Add entity reference fields (type + ID)
  - [ ] Add action enum field
  - [ ] Add user tracking fields
  - [ ] Add changes field (optional JSON)
  - [ ] Create indexes: by_entity, by_user, by_timestamp

- [ ] **Add Indexes for Performance** (AC: 4)
  - [ ] Review all new tables for index needs
  - [ ] Add indexes for foreign key relationships
  - [ ] Add indexes for status/state fields
  - [ ] Add indexes for timestamp fields
  - [ ] Document index strategy in schema comments

- [ ] **Test Backwards Compatibility** (AC: 5)
  - [ ] Run existing content queries against new schema
  - [ ] Verify no breaking changes
  - [ ] Test existing mutations still work
  - [ ] Document any required code changes
  - [ ] Create migration guide if needed

- [ ] **Schema Validation** (AC: All)
  - [ ] Run TypeScript type checking
  - [ ] Deploy schema to dev environment
  - [ ] Test schema with sample data
  - [ ] Verify indexes are created correctly
  - [ ] Performance test key queries

## Dev Notes

### Technology Stack Context
[Source: docs/TECHNICAL_OVERVIEW.md, docs/CONVEX_ARCHITECTURE.md]
- **Backend**: Convex (serverless backend with real-time database)
- **Schema Language**: Convex schema definitions with TypeScript validation
- **Architecture**: Convex as single source of truth for operational data
- **Pattern**: Minimal schema design for efficient CRUD operations

### Current Schema State
[Source: convex/schema.ts]
- ✅ **Existing Content Table**: Has basic fields but lacks authorship tracking
- ✅ **Type System**: Uses v.union() for enums, v.optional() for nullable fields
- ✅ **Indexing**: Existing pattern using .index() and .searchIndex()
- ✅ **Relationships**: Uses v.id() for foreign keys

### Winston's Refined Schema Design
[Source: docs/CONVEX_ARCHITECTURE.md, Epic 2 discussion]

#### Table 1: `media_assets` (Simplified from original expansion plan)
```typescript
media_assets: defineTable({
  // Basic info
  title: v.string(),
  description: v.optional(v.string()),

  // File details
  file_type: v.union(v.literal("video"), v.literal("image"), v.literal("audio")),

  // UploadThing integration
  uploadthing_key: v.string(),
  uploadthing_url: v.string(),

  // Video metadata (for videos only)
  duration_seconds: v.optional(v.number()),
  video_width: v.optional(v.number()),
  video_height: v.optional(v.number()),

  // Optional HLS streaming (future)
  hls_playlist_url: v.optional(v.string()),

  // Organization
  folder_path: v.optional(v.string()),  // Simple path string: "sports/volleyball/highlights"
  tags: v.array(v.string()),

  // Access control
  status: v.union(
    v.literal("uploading"),
    v.literal("ready"),
    v.literal("failed"),
    v.literal("archived")
  ),

  // Authorship
  uploaded_by: v.id("users"),
  created_at: v.number(),

  // Simple analytics
  view_count: v.number(),
})
  .index("by_status", ["status"])
  .index("by_uploader", ["uploaded_by"])
  .index("by_type", ["file_type"])
  .searchIndex("search_media", {
    searchField: "title",
    filterFields: ["status", "file_type", "tags"]
  }),
```

**Design Rationale:**
- ✅ Simplified from original expansion plan (no complex folder table)
- ✅ Uses string paths for folder organization (easier queries)
- ✅ Future-proof with optional HLS field
- ✅ Direct UploadThing integration
- ✅ Simple view count (PostHog handles complex analytics)

#### Table 2: Enhanced `content` Table (Add these fields)
```typescript
// ADD to existing content table definition:
  created_by: v.id("users"),              // Admin who created
  updated_by: v.optional(v.id("users")),  // Last admin who edited
  created_at: v.number(),
  updated_at: v.number(),

  // Enhanced workflow
  workflow_status: v.optional(v.union(
    v.literal("draft"),
    v.literal("pending_review"),
    v.literal("approved"),
    v.literal("published"),
    v.literal("archived")
  )),
  reviewed_by: v.optional(v.id("users")),
  reviewed_at: v.optional(v.number()),

  // Link to media assets
  media_asset_ids: v.optional(v.array(v.id("media_assets"))),

// ADD these indexes:
  .index("by_created_by", ["created_by"])
  .index("by_workflow_status", ["workflow_status"])
```

**Design Rationale:**
- ✅ Maintains backwards compatibility (all new fields optional initially)
- ✅ Tracks full content lifecycle
- ✅ Links content to uploaded media
- ✅ Enables audit queries by creator

#### Table 3: `content_audit_log`
```typescript
content_audit_log: defineTable({
  // What was changed
  entity_type: v.union(v.literal("content"), v.literal("media_asset")),
  entity_id: v.string(),  // Use string to support both types

  // Action performed
  action: v.union(
    v.literal("created"),
    v.literal("updated"),
    v.literal("published"),
    v.literal("archived"),
    v.literal("deleted")
  ),

  // Who did it
  user_id: v.id("users"),
  user_email: v.string(),
  user_role: v.string(),

  // What changed (simple JSON)
  changes: v.optional(v.any()),  // Store before/after diffs

  // When
  timestamp: v.number(),
})
  .index("by_entity", ["entity_type", "entity_id"])
  .index("by_user", ["user_id"])
  .index("by_timestamp", ["timestamp"]),
```

**Design Rationale:**
- ✅ Generic design supports multiple entity types
- ✅ Captures all necessary audit information
- ✅ Indexed for fast audit trail queries
- ✅ Stores user context (email, role) for compliance

### Migration Strategy

**Phase 1: Schema Addition (This Story)**
1. Add new `media_assets` table
2. Add new `content_audit_log` table
3. Add new fields to `content` table (all optional)
4. Deploy to dev environment
5. Test with sample data

**Phase 2: Data Migration (Future Story)**
1. Migrate existing `video_url` fields to `media_assets` if needed
2. Backfill `created_by` for existing content (use system user)
3. Set initial `workflow_status` based on current `status`
4. Verify data integrity

**Phase 3: Enforcement (Future Story)**
1. Make `created_by` required in mutations
2. Enforce workflow transitions
3. Remove deprecated fields

**Rollback Strategy:**
- Schema additions are non-breaking (all optional fields)
- Can revert deployment without data loss
- Existing queries continue to work unchanged

### File Locations
[Source: docs/CONVEX_ARCHITECTURE.md]
- Schema Definition: `convex/schema.ts`
- Type Exports: Auto-generated in `convex/_generated/dataModel.d.ts`
- CRUD Functions: Will be in Story 1.6

### Testing Requirements

#### Schema Validation Tests
- TypeScript compilation succeeds
- All tables have valid field types
- All indexes reference existing fields
- No duplicate index names

#### Backwards Compatibility Tests
- Existing content queries return results
- Existing content mutations succeed
- No runtime errors with new schema
- Performance of existing queries unchanged

#### Integration Tests
- Can insert into new tables
- Foreign key relationships work
- Indexes improve query performance
- Search indexes return relevant results

### Performance Considerations
[Source: docs/CONVEX_ARCHITECTURE.md]

**Indexing Strategy:**
- ✅ Index all foreign keys for joins
- ✅ Index status/state fields for filtering
- ✅ Index timestamps for sorting
- ✅ Add search indexes for text search

**Query Patterns to Optimize:**
- Get media assets by uploader
- Get content by creator
- Get audit log for specific content
- Search media by title
- Filter content by workflow status

**Expected Query Times:**
- Indexed queries: < 50ms
- Search queries: < 100ms
- Full table scans: Avoid with proper indexes

### Security Considerations
[Source: lib/auth/adminAuth.ts, convex/admin.ts]

**Authorization:**
- Schema itself has no auth (handled in functions)
- CRUD operations will require admin auth (Story 1.6)
- Audit log entries capture user context

**Data Validation:**
- Convex validates types automatically
- Additional validation in mutations (Story 1.6)
- Required fields enforced by schema

### Dependencies

**Prerequisite Work:**
- ✅ Convex backend configured
- ✅ Existing schema deployed
- ✅ UploadThing account set up
- ✅ Admin authentication working

**Blocks:**
- Story 1.4 (Real-time Features Schema) - Can start in parallel
- Story 1.5 (Analytics Integration) - Can start in parallel
- Story 1.6 (CRUD Functions) - Must wait for this story

### Known Limitations & Future Work

**Current Limitations:**
- No automated HLS transcoding (using direct UploadThing URLs)
- Simple folder paths (no hierarchical folder table)
- Basic view count (complex analytics in PostHog)

**Future Enhancements (Out of Scope for MVP):**
- Add `media_processing_jobs` table for transcoding
- Add `media_folders` table for hierarchy
- Add file size limits and validation
- Add content versioning

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-07 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

*Results from QA Agent review will be added here after implementation*
