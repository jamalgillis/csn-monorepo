# Story 1.5: Analytics Integration Layer - PostHog via Convex Actions

## Status
Ready for Development

## Story

**As a** CSN platform stakeholder,
**I want** secure, enriched analytics tracking of all user interactions via PostHog,
**so that** we can make data-driven product decisions without exposing API keys and with full context about user behavior.

## Acceptance Criteria

1. **Post Hog Action Layer**: Create `convex/analytics.ts` with PostHog integration:
   - Initialize PostHog client with environment variable
   - Implement actions (not queries/mutations) for security
   - Fetch metadata from Convex DB before sending events
   - Handle authentication and user identity
   - Implement error handling and logging

2. **Video Playback Events**: Track core video engagement:
   - `trackVideoPlay` - Video playback started
   - `trackVideoPause` - Video paused by user
   - `trackVideoComplete` - Video watched to completion (>90%)
   - `trackVideoSeek` - User skipped forward/backward
   - All events include enriched metadata (title, type, tags, duration)

3. **Content Engagement Events**: Track user content interactions:
   - `trackContentAdded` - Added to watchlist/favorites
   - `trackContentRemoved` - Removed from watchlist/favorites
   - `trackContentRate` - Thumbs up/down rating
   - `trackContentShare` - Content shared
   - All events include content metadata

4. **Admin Operation Events**: Track administrative actions:
   - `trackAdminContentCreate` - Content created by admin
   - `trackAdminContentPublish` - Content published
   - `trackAdminMediaUpload` - Media file uploaded
   - `trackAdminGameSchedule` - Game scheduled
   - All events include admin user context

5. **Error Handling & Security**: Ensure robust implementation:
   - PostHog API key stored in environment variable only
   - No API keys exposed to frontend
   - Failed events logged but don't block user actions
   - Optional retry logic for failed sends
   - User identity fetched securely via Convex auth

## Tasks / Subtasks

- [ ] **Set Up PostHog Integration** (AC: 1)
  - [ ] Install `posthog-node` package
  - [ ] Create `convex/analytics.ts` file
  - [ ] Initialize PostHog client with env var
  - [ ] Add POSTHOG_API_KEY to `.env.local`
  - [ ] Document environment setup

- [ ] **Implement Video Playback Events** (AC: 2)
  - [ ] Create `trackVideoPlay` action
  - [ ] Create `trackVideoPause` action
  - [ ] Create `trackVideoComplete` action
  - [ ] Create `trackVideoSeek` action
  - [ ] Add metadata enrichment from content table
  - [ ] Test events appear in PostHog dashboard

- [ ] **Implement Content Engagement Events** (AC: 3)
  - [ ] Create `trackContentAdded` action
  - [ ] Create `trackContentRemoved` action
  - [ ] Create `trackContentRate` action
  - [ ] Create `trackContentShare` action
  - [ ] Add metadata enrichment
  - [ ] Test event properties

- [ ] **Implement Admin Operation Events** (AC: 4)
  - [ ] Create `trackAdminContentCreate` action
  - [ ] Create `trackAdminContentPublish` action
  - [ ] Create `trackAdminMediaUpload` action
  - [ ] Create `trackAdminGameSchedule` action
  - [ ] Add admin context (role, email)
  - [ ] Test admin events tracked correctly

- [ ] **Add Error Handling** (AC: 5)
  - [ ] Wrap PostHog calls in try-catch
  - [ ] Log errors without throwing
  - [ ] Verify failed events don't block UI
  - [ ] Add optional retry logic
  - [ ] Document error handling strategy

- [ ] **Integration Testing** (AC: All)
  - [ ] Test all events reach PostHog
  - [ ] Verify enriched metadata present
  - [ ] Test anonymous user handling
  - [ ] Test admin auth context
  - [ ] Performance test (latency acceptable)

## Dev Notes

### Technology Stack Context
[Source: docs/CONVEX_ARCHITECTURE.md]
- **Analytics Platform**: PostHog (self-hosted or cloud)
- **Integration Pattern**: Convex actions as analytics gateway
- **Security**: API keys never exposed to frontend
- **Performance**: Actions are async, don't block user interactions

### PostHog Integration Architecture
[Source: docs/CONVEX_ARCHITECTURE.md]

**Why Convex Actions?**
1. **Security**: PostHog API key stays server-side
2. **Enrichment**: Fetch related data from Convex DB
3. **Consistency**: Single source of event structure
4. **Validation**: Server-side validation before sending

**Pattern:**
```
Client → Convex Action → PostHog
   ↓         ↓
   ↓    (Fetch metadata)
   ↓         ↓
useQuery  Database
```

### Implementation Guide

#### File Structure
```
convex/
  analytics.ts         ← New file (this story)
  _generated/
    api.d.ts          ← Auto-generated action exports
```

#### PostHog Client Initialization
```typescript
// convex/analytics.ts
import { action } from "./_generated/server";
import { api } from "./_generated/api";
import { v } from "convex/values";
import { PostHog } from 'posthog-node';

// Initialize PostHog (use environment variable)
const posthog = new PostHog(
  process.env.POSTHOG_API_KEY!,
  {
    host: process.env.POSTHOG_HOST || 'https://app.posthog.com',
    flushAt: 20,      // Send batch after 20 events
    flushInterval: 10000, // or every 10 seconds
  }
);

// Ensure events are sent before shutdown
process.on('SIGTERM', async () => {
  await posthog.shutdown();
});
```

#### Video Play Event Example
```typescript
export const trackVideoPlay = action({
  args: {
    videoId: v.id("content"),
    position: v.number(),  // Starting position in seconds
  },
  handler: async (ctx, args) => {
    try {
      // 1. Get user identity (may be null for anonymous)
      const identity = await ctx.auth.getUserIdentity();
      if (!identity) {
        // Optional: track anonymous users with session ID
        return;
      }

      // 2. Fetch video metadata from Convex
      const video = await ctx.runQuery(api.content.getContentById, {
        id: args.videoId
      });

      if (!video) {
        console.error(`Video not found: ${args.videoId}`);
        return;
      }

      // 3. Send enriched event to PostHog
      posthog.capture({
        distinctId: identity.subject,  // User ID
        event: 'video_play',
        properties: {
          // Video details
          video_id: args.videoId,
          video_title: video.title,
          video_type: video.type,
          video_year: video.year,
          video_runtime_minutes: video.runtime,

          // Playback details
          position_seconds: args.position,
          is_resume: args.position > 0,

          // Metadata
          tags: video.tag_names,
          is_premium: !!video.video_url,
          is_featured: video.featured,

          // User context
          user_email: identity.email,
          timestamp: Date.now(),
        }
      });
    } catch (error) {
      // Log error but don't throw (don't block user action)
      console.error('Failed to track video_play:', error);
    }
  }
});
```

#### Complete Event Catalog

**Video Playback Events:**
```typescript
// Video play
posthog.capture({
  event: 'video_play',
  properties: {
    video_id, video_title, video_type,
    position_seconds, is_resume,
    tags, is_premium
  }
});

// Video pause
posthog.capture({
  event: 'video_pause',
  properties: {
    video_id, video_title,
    position_seconds, watch_duration_seconds
  }
});

// Video complete (>90% watched)
posthog.capture({
  event: 'video_complete',
  properties: {
    video_id, video_title,
    watch_duration_seconds, completion_percentage
  }
});

// Video seek
posthog.capture({
  event: 'video_seek',
  properties: {
    video_id, video_title,
    from_position_seconds, to_position_seconds,
    seek_direction: 'forward' | 'backward'
  }
});
```

**Content Engagement Events:**
```typescript
// Content added to list
posthog.capture({
  event: 'content_added',
  properties: {
    content_id, content_title, content_type,
    added_to: 'watchlist' | 'favorites',
    tags
  }
});

// Content rated
posthog.capture({
  event: 'content_rated',
  properties: {
    content_id, content_title,
    rating: 'up' | 'down',
    previous_rating: 'up' | 'down' | null
  }
});

// Content shared
posthog.capture({
  event: 'content_shared',
  properties: {
    content_id, content_title,
    share_method: 'copy_link' | 'social',
    platform: 'twitter' | 'facebook' | etc
  }
});
```

**Admin Operation Events:**
```typescript
// Admin creates content
posthog.capture({
  event: 'admin_content_create',
  properties: {
    content_id, content_title, content_type,
    admin_user_id, admin_email, admin_role,
    workflow_status: 'draft'
  }
});

// Admin publishes content
posthog.capture({
  event: 'admin_content_publish',
  properties: {
    content_id, content_title, content_type,
    admin_user_id, admin_email, admin_role,
    time_to_publish_hours  // From creation to publish
  }
});

// Admin uploads media
posthog.capture({
  event: 'admin_media_upload',
  properties: {
    media_id, media_title, file_type,
    file_size_mb, duration_seconds,
    admin_user_id, admin_email
  }
});
```

### Environment Configuration

```bash
# .env.local
POSTHOG_API_KEY=phc_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
POSTHOG_HOST=https://app.posthog.com  # or self-hosted URL
```

**Security Notes:**
- ✅ Never commit `.env.local` to git (in `.gitignore`)
- ✅ Use different keys for dev/staging/prod
- ✅ PostHog Project API Key (not Personal API Key)

### Frontend Integration

**Calling Analytics Actions:**
```typescript
// In React component
import { useMutation } from "convex/react";
import { api } from "../convex/_generated/api";

function VideoPlayer({ videoId }) {
  const trackPlay = useMutation(api.analytics.trackVideoPlay);
  const trackPause = useMutation(api.analytics.trackVideoPause);

  const handlePlay = async () => {
    // Start playback
    videoRef.current.play();

    // Track event (async, non-blocking)
    await trackPlay({
      videoId,
      position: videoRef.current.currentTime
    });
  };

  const handlePause = async () => {
    await trackPause({
      videoId,
      position: videoRef.current.currentTime,
      watchDuration: calculateWatchDuration()
    });
  };

  return <video ref={videoRef} onPlay={handlePlay} onPause={handlePause} />;
}
```

### Error Handling Strategy

**Principles:**
1. ✅ Analytics failures should NEVER block user actions
2. ✅ Log errors for debugging but don't throw
3. ✅ Optional: retry failed events with exponential backoff
4. ✅ Monitor error rates in production

**Implementation:**
```typescript
export const trackVideoPlay = action({
  args: { /* ... */ },
  handler: async (ctx, args) => {
    try {
      // Fetch metadata
      const video = await ctx.runQuery(/*...*/);

      // Send to PostHog
      posthog.capture({/*...*/});

    } catch (error) {
      // Log but don't throw
      console.error('[Analytics] Failed to track video_play:', {
        error: error.message,
        videoId: args.videoId,
        timestamp: Date.now()
      });

      // Optional: queue for retry
      // await queueForRetry('video_play', args);
    }
  }
});
```

### Testing Strategy

#### Unit Tests (Future Story)
- Mock PostHog client
- Test event structure
- Test error handling

#### Integration Tests
1. **Manual Testing in Dev:**
   - Trigger each event type
   - Check PostHog dashboard
   - Verify all properties present
   - Check enriched metadata correct

2. **Automated Tests:**
   - Test actions can be called
   - Verify no errors thrown on failure
   - Test with missing/invalid videoId

#### PostHog Dashboard Verification
- Events appear in Live Events stream
- Properties formatted correctly
- User identification works
- Event timestamps accurate

### Performance Considerations

**Expected Latency:**
- Action execution: < 1 second (acceptable for async)
- PostHog API response: typically < 500ms
- User experience: non-blocking (fire-and-forget)

**Batch Sending:**
- PostHog SDK batches events automatically
- `flushAt: 20` sends after 20 events
- `flushInterval: 10000` sends every 10s
- Manual flush on shutdown

### Dependencies

**Prerequisite Work:**
- ✅ PostHog account created
- ✅ PostHog project API key obtained
- ✅ Convex actions enabled (default)

**Can Run in Parallel With:**
- Story 1.3 (Core Schema)
- Story 1.4 (Real-time Schema)

**Blocks:**
- Story 1.6 (CRUD Functions) - Should integrate analytics tracking

### Known Limitations & Future Work

**Current Limitations:**
- No offline event queuing
- No automatic retry on failure
- No rate limiting
- Simple error logging (not structured)

**Future Enhancements:**
- Add event queue for offline support
- Implement retry with exponential backoff
- Add structured error logging
- Add rate limiting per user
- Add event sampling for high-volume events

### PostHog Dashboard Setup

**Recommended Actions (Post-Implementation):**
1. Create insights for key metrics:
   - Video completion rate by content type
   - Most watched content
   - User engagement funnel
   - Admin activity timeline

2. Set up dashboards:
   - User Engagement Dashboard
   - Content Performance Dashboard
   - Admin Operations Dashboard

3. Configure alerts:
   - Sudden drop in video plays
   - High video abandonment rate
   - Admin error spike

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-07 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

*Results from QA Agent review will be added here after implementation*
